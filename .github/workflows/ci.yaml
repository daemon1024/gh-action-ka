name: Runtime-risks
on:
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened]
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  Tests:
    runs-on: ubuntu-latest
    steps:

      - uses: actions/checkout@v3

      - name: Installing Prerequisites (Kind Cluster)
        uses: helm/kind-action@v1.4.0

      - name: Configuring and testing the Installation for cluster
        run: |
          kubectl cluster-info --context kind-chart-testing
          kubectl wait --for=condition=Ready nodes --all --timeout=120s
          

      - name: Install karmor, kubearmor and discovery engine
        run: |
          curl -sfL http://get.kubearmor.io/ | sudo sh -s -- -b /usr/local/bin
          karmor version
          karmor install
          kubectl apply -f https://raw.githubusercontent.com/kubearmor/discovery-engine/dev/deployments/k8s/deployment.yaml
          sleep 5s
          kubectl wait --for=condition=Ready pods --all -n accuknox-agents --timeout=120s
          

      - name: Checkout Kubearmor repo
        uses: actions/checkout@v3
        with:
          repository: kubearmor/kubearmor
          path: kubearmor

      #      - name: Run e2e tests
      #        run: |
      #          ls
      #          cd kubearmor/tests
      #          go install -mod=mod github.com/onsi/ginkgo/ginkgo
      #          make test

      - name: Deploy test application
        run: |
          kubectl create deployment nginx --image=nginx
          POD=$(kubectl get pod -l app=nginx -o name)
          kubectl wait --for=condition=Ready pods --all -A --timeout=120s
          kubectl exec -it $POD -- sh -c "sleep 1"
          

      - name: Generate report
        run: |
          kubectl get pods -A
          karmor summary 
          

#      - name: Compare baseline report
#        run: |
#          git diff /tmp/baseline.json /tmp/summary.json --histogram
